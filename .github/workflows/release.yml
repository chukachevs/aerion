name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      os:
        description: "Select OS to build"
        required: true
        default: "all"
        type: choice
        options:
          - all
          - linux
          - darwin
          - windows

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            platform: linux
            arch: amd64
          - os: ubuntu-22.04-arm
            platform: linux
            arch: arm64
          - os: macos-latest
            platform: darwin
            arch: amd64
          - os: macos-latest
            platform: darwin
            arch: arm64
          - os: windows-latest
            platform: windows
            arch: amd64
          - os: windows-latest
            platform: windows
            arch: arm64

    runs-on: ${{ matrix.os }}

    env:
      GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
      GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
      MICROSOFT_CLIENT_ID: ${{ secrets.MICROSOFT_CLIENT_ID }}

    steps:
      - name: Skip if OS not selected
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.os != 'all' && github.event.inputs.os != matrix.platform
        run: |
          echo "Skipping ${{ matrix.platform }}"
          exit 0

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache: true

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Wails CLI
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Install Linux dependencies
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev

      - name: Install frontend dependencies
        run: |
          cd frontend
          npm install

      # ---------- LINUX ----------
      - name: Build (Linux)
        if: matrix.platform == 'linux'
        run: |
          make build-linux

          if [ "${{ matrix.arch }}" = "amd64" ]; then
            mv build/bin/aerion build/bin/aerion-${{ github.ref_name }}-linux-x86_64
          else
            mv build/bin/aerion build/bin/aerion-${{ github.ref_name }}-linux-aarch64
          fi

          CGO_ENABLED=0 GOARCH=${{ matrix.arch }} go build \
            -ldflags "-X 'main.GoogleClientID=$GOOGLE_CLIENT_ID' -X 'main.GoogleClientSecret=$GOOGLE_CLIENT_SECRET' -X 'main.MicrosoftClientID=$MICROSOFT_CLIENT_ID'" \
            -o build/bin/flathub-build-env-${{ github.ref_name }}-linux-${{ matrix.arch }} \
            cmd/aerion-creds/main.go

          mkdir -p dist-package
          cp build/bin/aerion-* dist-package/aerion
          cp build/linux/install.sh dist-package/
          cp build/linux/uninstall.sh dist-package/
          cp build/linux/aerion.desktop dist-package/io.github.hkdb.Aerion.desktop
          cp build/linux/aerion.png dist-package/io.github.hkdb.Aerion.png

          tar czf aerion-linux-${{ matrix.arch }}.tar.gz -C dist-package .
          rm -rf dist-package

      # ---------- macOS ----------
      - name: Build (macOS)
        if: matrix.platform == 'darwin'
        env:
          GOARCH: ${{ matrix.arch }}
        run: |
          make build
          cd build/bin
          zip -r Aerion-darwin-${{ matrix.arch }}.zip Aerion.app
          rm -rf Aerion.app

      # ---------- WINDOWS ----------
      - name: Build (Windows)
        if: matrix.platform == 'windows'
        shell: pwsh
        env:
          GOARCH: ${{ matrix.arch }}
        run: |
          make build
          Move-Item build/bin/aerion.exe build/bin/Aerion-windows-${{ matrix.arch }}.exe

      - uses: actions/upload-artifact@v4
        with:
          name: aerion-${{ matrix.platform }}-${{ matrix.arch }}
          path: |
            build/bin/*
            aerion-*.tar.gz
          retention-days: 1

  publish:
    if: startsWith(github.ref, 'refs/tags/')
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - uses: actions/download-artifact@v4

      - name: Upload artifacts to Release
        run: |
          gh release upload ${{ github.ref_name }} \
            aerion-*/build/bin/* \
            aerion-*/*.tar.gz \
            --clobber

  update-manifest:
    if: startsWith(github.ref, 'refs/tags/')
    needs: publish
    runs-on: ubuntu-24.04

    steps:
      - uses: actions/checkout@v4

      - run: sudo apt-get update && sudo apt-get install -y wget

      - run: |
          cd build/flatpak/flathub
          chmod +x calculate-hashes.sh
          ./calculate-hashes.sh ${{ github.ref_name }}

      - uses: actions/upload-artifact@v4
        with:
          name: flathub-manifest
          path: build/flatpak/flathub/io.github.hkdb.Aerion.yml
          retention-days: 1

  build-flatpak:
    if: startsWith(github.ref, 'refs/tags/')
    needs: update-manifest
    strategy:
      matrix:
        include:
          - os: ubuntu-24.04
            arch: x86_64
          - os: ubuntu-24.04-arm
            arch: aarch64

    runs-on: ${{ matrix.os }}
    permissions:
      contents: write
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: flathub-manifest
          path: build/flatpak/flathub

      - run: |
          sudo apt-get update
          sudo apt-get install -y flatpak flatpak-builder

      - run: flatpak remote-add --if-not-exists --user flathub https://flathub.org/repo/flathub.flatpakrepo

      - run: |
          flatpak install -y --user flathub \
            org.gnome.Platform//49 \
            org.gnome.Sdk//49 \
            org.freedesktop.Sdk.Extension.golang//24.08 \
            org.freedesktop.Sdk.Extension.node20//24.08

      - run: rm -rf .flatpak-builder

      - run: |
          flatpak-builder --user --force-clean --repo=repo \
            --install-deps-from=flathub \
            build-dir build/flatpak/flathub/io.github.hkdb.Aerion.yml

          mkdir -p build/bin
          flatpak build-bundle repo build/bin/Aerion-${{ github.ref_name }}-${{ matrix.arch }}.flatpak io.github.hkdb.Aerion

      - run: |
          gh release upload ${{ github.ref_name }} \
            build/bin/Aerion-${{ github.ref_name }}-${{ matrix.arch }}.flatpak \
            --clobber

  commit-manifest:
    if: startsWith(github.ref, 'refs/tags/')
    needs: build-flatpak
    runs-on: ubuntu-24.04
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: flathub-manifest
          path: build/flatpak/flathub

      - run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout main
          git add build/flatpak/flathub/io.github.hkdb.Aerion.yml
          git commit -m "${{ github.ref_name }} - Flathub submission" || echo "No changes"
          git push origin main
